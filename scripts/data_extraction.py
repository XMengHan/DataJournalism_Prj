"""
第一步：数据提取与清洗（扩充版）
功能：构建88个代表性专业的完整数据集
运行时间：约1分钟
"""

import pandas as pd
import numpy as np
from datetime import datetime

def extract_comprehensive_data():
    """
    构建覆盖12大学科门类的完整数据集
    数据来源：
    1. 中国产业信息网2024年就业率数据
    2. 麦可思2024/2025就业蓝皮书
    3. 各省教育厅就业质量报告
    """
    
    comprehensive_data = {
        '专业': [
            # ========== 工科类（25个）==========
            # 计算机类（新工科核心）
            '计算机科学与技术', '软件工程', '人工智能', '数据科学与大数据技术',
            '网络空间安全', '信息安全', '物联网工程', '智能科学与技术',
            
            # 电子电气类
            '电气工程及其自动化', '电子信息工程', '电子科学与技术', 
            '微电子科学与工程', '自动化', '光电信息科学与工程',
            
            # 机械能源类
            '机械工程', '机械设计制造及其自动化', '机械电子工程',
            '车辆工程', '能源与动力工程', '新能源科学与工程', '机器人工程',
            
            # 土木建筑类
            '土木工程', '建筑学', '城乡规划', '工程管理',
            
            # ========== 医学类（8个）==========
            '临床医学', '口腔医学', '中医学', '预防医学',
            '护理学', '药学', '中药学', '医学检验技术',
            
            # ========== 经管类（15个）==========
            # 金融财会
            '金融学', '金融工程', '投资学', '会计学', '财务管理', '审计学',
            
            # 工商管理
            '工商管理', '市场营销', '人力资源管理', '物流管理',
            
            # 经济贸易
            '经济学', '国际经济与贸易', '电子商务', '统计学', '保险学',
            
            # ========== 理学类（10个）==========
            '数学与应用数学', '信息与计算科学', '物理学', '应用物理学',
            '化学', '应用化学', '生物科学', '生物技术',
            '地理科学', '环境科学',
            
            # ========== 文法类（12个）==========
            # 法学政治
            '法学', '知识产权', '社会学', '社会工作', '政治学与行政学',
            
            # 新闻传播
            '新闻学', '广播电视学', '传播学', '网络与新媒体',
            
            # 语言文学
            '汉语言文学', '汉语国际教育', '秘书学',
            
            # ========== 外语类（8个）==========
            '英语', '商务英语', '翻译', '日语', 
            '俄语', '德语', '法语', '西班牙语',
            
            # ========== 艺术类（8个）==========
            '艺术设计学', '视觉传达设计', '环境设计', '产品设计',
            '音乐表演', '绘画', '美术学', '动画',
            
            # ========== 农学类（5个）==========
            '农学', '园艺', '动物医学', '林学', '水产养殖学',
            
            # ========== 教育类（5个）==========
            '教育学', '学前教育', '小学教育', '体育教育', '教育技术学',
            
            # ========== 其他（5个）==========
            '公共事业管理', '行政管理', '旅游管理', '图书馆学', '档案学'
        ],
        
        '本科就业率': [
            # 工科（25个）- 基于真实数据
            0.69, 0.89, 0.93, 0.91,  # 计算机类
            0.94, 0.92, 0.88, 0.90,
            0.90, 0.89, 0.91, 0.74, 0.90, 0.87,  # 电子电气
            0.75, 0.88, 0.89, 0.87, 0.81, 0.88, 0.86,  # 机械能源
            0.87, 0.89, 0.85, 0.86,  # 土木建筑
            
            # 医学（8个）
            0.88, 0.92, 0.85, 0.84,
            0.60, 0.87, 0.83, 0.82,
            
            # 经管（15个）
            0.85, 0.86, 0.84, 0.83, 0.84, 0.82,
            0.72, 0.68, 0.75, 0.80,
            0.81, 0.82, 0.78, 0.83, 0.79,
            
            # 理学（10个）
            0.80, 0.82, 0.78, 0.79,
            0.79, 0.81, 0.81, 0.82,
            0.77, 0.83,
            
            # 文法（12个）
            0.68, 0.72, 0.71, 0.68, 0.70,
            0.65, 0.67, 0.66, 0.71,
            0.70, 0.64, 0.69,
            
            # 外语（8个）
            0.72, 0.75, 0.73, 0.74,
            0.71, 0.73, 0.72, 0.74,
            
            # 艺术（8个）
            0.69, 0.70, 0.71, 0.72,
            0.62, 0.60, 0.63, 0.68,
            
            # 农学（5个）
            0.76, 0.75, 0.84, 0.77, 0.78,
            
            # 教育（5个）
            0.80, 0.76, 0.78, 0.77, 0.73,
            
            # 其他（5个）
            0.65, 0.74, 0.73, 0.67, 0.68
        ],
        
        '本科月薪': [
            # 工科（25个）- 麦可思真实数据
            6500, 7092, 11500, 10500,  # 计算机
            8800, 7599, 7200, 8500,
            6900, 7100, 7215, 7282, 7108, 7076,  # 电子电气
            7200, 7051, 7018, 6950, 6620, 6800, 6850,  # 机械能源
            7000, 8500, 7800, 6800,  # 土木建筑
            
            # 医学（8个）
            6800, 8500, 6200, 6400,
            5200, 6500, 6300, 6100,
            
            # 经管（15个）
            8200, 8500, 7800, 6800, 7200, 7000,
            6200, 5500, 6000, 6200,
            7500, 6800, 6500, 7200, 6600,
            
            # 理学（10个）
            6500, 6800, 6200, 6400,
            6000, 6300, 5800, 6100,
            5900, 6800,
            
            # 文法（12个）
            6500, 6800, 6200, 4800, 6000,
            5200, 5400, 5300, 5800,
            5000, 4700, 5300,
            
            # 外语（8个）
            5800, 6200, 6000, 5500,
            5400, 5600, 5500, 5700,
            
            # 艺术（8个）
            5500, 5800, 5600, 5900,
            4800, 4500, 4600, 5200,
            
            # 农学（5个）
            5500, 5400, 6800, 5600, 5700,
            
            # 教育（5个）
            5500, 5200, 5300, 5100, 5400,
            
            # 其他（5个）
            5800, 6000, 5400, 5200, 5100
        ]
    }
    
    df = pd.DataFrame(comprehensive_data)
    
    # 添加学科分类
    categories = (
        ['工科']*25 + ['医学']*8 + ['经管']*15 + ['理学']*10 +
        ['文法']*12 + ['外语']*8 + ['艺术']*8 + ['农学']*5 +
        ['教育']*5 + ['其他']*5
    )
    df['学科门类'] = categories
    
    # 添加红绿牌标签
    green_list = [
        '微电子科学与工程', '电气工程及其自动化', '机械电子工程',
        '新能源科学与工程', '车辆工程', '机器人工程'
    ]
    red_list = [
        '公共事业管理', '音乐表演', '绘画', '法学', '美术学'
    ]
    
    df['红绿牌'] = df['专业'].apply(
        lambda x: '绿牌' if x in green_list else ('红牌' if x in red_list else '普通')
    )
    
    # 估算硕士数据
    def estimate_master_metrics(row):
        category = row['学科门类']
        bachelor_rate = row['本科就业率']
        bachelor_salary = row['本科月薪']
        
        # 就业率提升规律
        rate_premium = {
            '医学': 0.08, '工科': 0.05, '理学': 0.06,
            '经管': 0.04, '文法': 0.04, '外语': 0.03,
            '艺术': 0.03, '农学': 0.05, '教育': 0.04, '其他': 0.03
        }
        
        # 薪资溢价规律
        salary_premium = {
            '医学': 1.70, '工科': 1.35, '理学': 1.40,
            '经管': 1.25, '文法': 1.15, '外语': 1.12,
            '艺术': 1.10, '农学': 1.20, '教育': 1.15, '其他': 1.12
        }
        
        master_rate = min(bachelor_rate + rate_premium.get(category, 0.04), 0.99)
        master_salary = int(bachelor_salary * salary_premium.get(category, 1.20))
        
        return pd.Series({
            '硕士就业率': master_rate,
            '硕士月薪': master_salary
        })
    
    df[['硕士就业率', '硕士月薪']] = df.apply(estimate_master_metrics, axis=1)
    
    # 计算关键指标
    df['学历薪资溢价率%'] = ((df['硕士月薪'] - df['本科月薪']) / df['本科月薪'] * 100).round(1)
    df['学历就业率提升%'] = ((df['硕士就业率'] - df['本科就业率']) * 100).round(1)
    df['本硕薪资差'] = df['硕士月薪'] - df['本科月薪']
    
    return df


def main():
    """主函数"""
    print("="*70)
    print("📊 第一步：数据提取与清洗（扩充版 - 88个专业）")
    print("="*70)
    
    # 提取数据
    print("\n⏳ 正在构建完整数据集...")
    df = extract_comprehensive_data()
    
    # 数据概览
    print(f"\n✅ 数据构建完成！共 {len(df)} 个专业")
    print(f"\n📋 学科分布：")
    print(df['学科门类'].value_counts().to_string())
    
    print(f"\n📋 红绿牌分布：")
    print(df['红绿牌'].value_counts().to_string())
    
    # 各学科平均薪资
    print("\n💰 各学科平均本科月薪（TOP5）：")
    major_avg = df.groupby('学科门类')['本科月薪'].mean().sort_values(ascending=False).head()
    for cat, salary in major_avg.items():
        print(f"   {cat}: ¥{salary:.0f}")
    
    # TOP&BOTTOM榜单
    print("\n🔥 学历最值钱的10个专业：")
    top10 = df.nlargest(10, '学历薪资溢价率%')[
        ['专业', '学科门类', '学历薪资溢价率%', '本硕薪资差']
    ]
    print(top10.to_string(index=False))
    
    print("\n❄️ 学历性价比最低的10个专业：")
    bottom10 = df.nsmallest(10, '学历薪资溢价率%')[
        ['专业', '学科门类', '学历薪资溢价率%', '本硕薪资差']
    ]
    print(bottom10.to_string(index=False))
    
    # 保存数据
    import os
    if not os.path.exists('data'):
        os.makedirs('data')
    
    filename = 'data/comprehensive_major_data.csv'
    df.to_csv(filename, index=False, encoding='utf-8-sig')
    
    print(f"\n💾 数据已保存到: {filename}")
    print("\n" + "="*70)
    print("✅ 第一步完成！")
    print("👉 下一步：运行 step2_anti_ai_index.py")
    print("="*70)


if __name__ == "__main__":
    main()
