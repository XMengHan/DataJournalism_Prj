"""
ç¬¬äºŒæ­¥ï¼šè®¡ç®—æŠ—AIæŒ‡æ•° + æ ¸å¿ƒåˆ†æ
åŠŸèƒ½ï¼š
1. ä¸‰ç»´æŠ—AIæŒ‡æ•°æ¨¡å‹
2. ä¸“ä¸šé£é™©è¯„çº§
3. å­¦å†é˜²æŠ¤æ•ˆåº”åˆ†æ
è¿è¡Œæ—¶é—´ï¼šçº¦2åˆ†é’Ÿ
"""

import pandas as pd
import numpy as np
from datetime import datetime

def calculate_anti_ai_index():
    """
    è®¡ç®—ä¸‰ç»´æŠ—AIæŒ‡æ•°
    
    ç»´åº¦è¯´æ˜ï¼š
    1. åˆ›é€ æ€§éœ€æ±‚ï¼ˆ40%æƒé‡ï¼‰ï¼šéœ€è¦åŸåˆ›æ€ç»´ã€å®¡ç¾åˆ¤æ–­çš„ç¨‹åº¦
    2. äººé™…äº¤äº’éœ€æ±‚ï¼ˆ30%æƒé‡ï¼‰ï¼šé¢å¯¹é¢æ²Ÿé€šã€æƒ…æ„Ÿè¿æ¥çš„å¿…è¦æ€§
    3. ä¸“ä¸šå£å’ï¼ˆ30%æƒé‡ï¼‰ï¼šèµ„è´¨è®¤è¯ã€é•¿æœŸè®­ç»ƒçš„é—¨æ§›
    
    è¯„åˆ†æ ‡å‡†ï¼šæ¯ä¸ªç»´åº¦0-10åˆ†
    - 8-10åˆ†ï¼šAIçŸ­æœŸå†…éš¾ä»¥æ›¿ä»£
    - 5-7åˆ†ï¼šAIå¯è¾…åŠ©ä½†éš¾å®Œå…¨æ›¿ä»£
    - 0-4åˆ†ï¼šAIæ›¿ä»£é£é™©é«˜
    """
    
    # è¯»å–æ•°æ®
    df = pd.read_csv('data/processed/comprehensive_major_data.csv')
    
    # ä¸“ä¸šç‰¹æ€§è¯„åˆ†åº“
    professional_scores = {
        # ========== å·¥ç§‘ç±» ==========
        # è®¡ç®—æœºç±»ï¼ˆé«˜åˆ›é€ ã€ä½äººé™…ã€ä¸­å£å’ï¼‰
        'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯': (7, 5, 6),
        'è½¯ä»¶å·¥ç¨‹': (8, 4, 6),
        'äººå·¥æ™ºèƒ½': (9, 4, 7),
        'æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯': (8, 5, 7),
        'ç½‘ç»œç©ºé—´å®‰å…¨': (7, 5, 8),
        'ä¿¡æ¯å®‰å…¨': (7, 5, 7),
        'ç‰©è”ç½‘å·¥ç¨‹': (7, 5, 6),
        'æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯': (9, 4, 7),
        
        # ç”µå­ç”µæ°”ç±»ï¼ˆä¸­åˆ›é€ ã€ä¸­äººé™…ã€ä¸­é«˜å£å’ï¼‰
        'ç”µæ°”å·¥ç¨‹åŠå…¶è‡ªåŠ¨åŒ–': (6, 5, 7),
        'ç”µå­ä¿¡æ¯å·¥ç¨‹': (7, 5, 7),
        'ç”µå­ç§‘å­¦ä¸æŠ€æœ¯': (7, 4, 7),
        'å¾®ç”µå­ç§‘å­¦ä¸å·¥ç¨‹': (8, 4, 8),
        'è‡ªåŠ¨åŒ–': (7, 4, 6),
        'å…‰ç”µä¿¡æ¯ç§‘å­¦ä¸å·¥ç¨‹': (8, 4, 7),
        
        # æœºæ¢°èƒ½æºç±»ï¼ˆä¸­åˆ›é€ ã€ä¸­äººé™…ã€ä¸­é«˜å£å’ï¼‰
        'æœºæ¢°å·¥ç¨‹': (6, 5, 7),
        'æœºæ¢°è®¾è®¡åˆ¶é€ åŠå…¶è‡ªåŠ¨åŒ–': (6, 5, 7),
        'æœºæ¢°ç”µå­å·¥ç¨‹': (7, 5, 7),
        'è½¦è¾†å·¥ç¨‹': (6, 5, 7),
        'èƒ½æºä¸åŠ¨åŠ›å·¥ç¨‹': (6, 5, 7),
        'æ–°èƒ½æºç§‘å­¦ä¸å·¥ç¨‹': (7, 5, 7),
        'æœºå™¨äººå·¥ç¨‹': (8, 4, 7),
        
        # åœŸæœ¨å»ºç­‘ç±»ï¼ˆé«˜åˆ›é€ ã€é«˜äººé™…ã€é«˜å£å’ï¼‰
        'åœŸæœ¨å·¥ç¨‹': (5, 6, 6),
        'å»ºç­‘å­¦': (9, 7, 8),
        'åŸä¹¡è§„åˆ’': (8, 7, 7),
        'å·¥ç¨‹ç®¡ç†': (5, 7, 5),
        
        # ========== åŒ»å­¦ç±»ï¼ˆæé«˜å£å’ï¼‰==========
        'ä¸´åºŠåŒ»å­¦': (8, 9, 10),
        'å£è…”åŒ»å­¦': (8, 9, 10),
        'ä¸­åŒ»å­¦': (9, 9, 10),
        'é¢„é˜²åŒ»å­¦': (7, 8, 9),
        'æŠ¤ç†å­¦': (6, 10, 8),
        'è¯å­¦': (7, 7, 9),
        'ä¸­è¯å­¦': (7, 7, 9),
        'åŒ»å­¦æ£€éªŒæŠ€æœ¯': (5, 6, 8),
        
        # ========== ç»ç®¡ç±» ==========
        # é‡‘èè´¢ä¼šï¼ˆä½åˆ›é€ ã€ä¸­äººé™…ã€ä¸­å£å’ï¼‰
        'é‡‘èå­¦': (6, 7, 5),
        'é‡‘èå·¥ç¨‹': (7, 6, 6),
        'æŠ•èµ„å­¦': (6, 7, 5),
        'ä¼šè®¡å­¦': (3, 5, 5),
        'è´¢åŠ¡ç®¡ç†': (4, 6, 4),
        'å®¡è®¡å­¦': (5, 6, 6),
        
        # å·¥å•†ç®¡ç†ï¼ˆä¸­åˆ›é€ ã€é«˜äººé™…ã€ä½å£å’ï¼‰
        'å·¥å•†ç®¡ç†': (5, 7, 3),
        'å¸‚åœºè¥é”€': (6, 8, 2),
        'äººåŠ›èµ„æºç®¡ç†': (6, 8, 4),
        'ç‰©æµç®¡ç†': (4, 6, 4),
        
        # ç»æµè´¸æ˜“
        'ç»æµå­¦': (7, 6, 6),
        'å›½é™…ç»æµä¸è´¸æ˜“': (5, 7, 4),
        'ç”µå­å•†åŠ¡': (6, 6, 3),
        'ç»Ÿè®¡å­¦': (6, 4, 6),
        'ä¿é™©å­¦': (5, 7, 5),
        
        # ========== ç†å­¦ç±»ï¼ˆé«˜åˆ›é€ ã€ä½äººé™…ã€é«˜å£å’ï¼‰==========
        'æ•°å­¦ä¸åº”ç”¨æ•°å­¦': (8, 4, 7),
        'ä¿¡æ¯ä¸è®¡ç®—ç§‘å­¦': (8, 4, 7),
        'ç‰©ç†å­¦': (9, 3, 8),
        'åº”ç”¨ç‰©ç†å­¦': (8, 4, 7),
        'åŒ–å­¦': (8, 4, 7),
        'åº”ç”¨åŒ–å­¦': (7, 5, 7),
        'ç”Ÿç‰©ç§‘å­¦': (8, 5, 7),
        'ç”Ÿç‰©æŠ€æœ¯': (8, 5, 7),
        'åœ°ç†ç§‘å­¦': (7, 5, 6),
        'ç¯å¢ƒç§‘å­¦': (7, 6, 6),
        
        # ========== æ–‡æ³•ç±» ==========
        # æ³•å­¦æ”¿æ²»ï¼ˆé«˜åˆ›é€ ã€é«˜äººé™…ã€é«˜å£å’ï¼‰
        'æ³•å­¦': (7, 8, 8),
        'çŸ¥è¯†äº§æƒ': (8, 7, 7),
        'ç¤¾ä¼šå­¦': (8, 7, 6),
        'ç¤¾ä¼šå·¥ä½œ': (7, 9, 6),
        'æ”¿æ²»å­¦ä¸è¡Œæ”¿å­¦': (8, 7, 7),
        
        # æ–°é—»ä¼ æ’­ï¼ˆé«˜åˆ›é€ ã€ä¸­äººé™…ã€ä½å£å’ï¼‰
        'æ–°é—»å­¦': (8, 7, 4),
        'å¹¿æ’­ç”µè§†å­¦': (8, 7, 4),
        'ä¼ æ’­å­¦': (8, 6, 4),
        'ç½‘ç»œä¸æ–°åª’ä½“': (8, 6, 3),
        
        # è¯­è¨€æ–‡å­¦ï¼ˆé«˜åˆ›é€ ã€ä¸­äººé™…ã€ä½å£å’ï¼‰
        'æ±‰è¯­è¨€æ–‡å­¦': (9, 6, 4),
        'æ±‰è¯­å›½é™…æ•™è‚²': (8, 8, 5),
        'ç§˜ä¹¦å­¦': (6, 7, 3),
        
        # ========== å¤–è¯­ç±»ï¼ˆä¸­åˆ›é€ ã€ä¸­äººé™…ã€ä½å£å’ï¼‰==========
        'è‹±è¯­': (5, 6, 3),
        'å•†åŠ¡è‹±è¯­': (5, 7, 4),
        'ç¿»è¯‘': (6, 5, 4),
        'æ—¥è¯­': (5, 6, 3),
        'ä¿„è¯­': (5, 6, 3),
        'å¾·è¯­': (5, 6, 3),
        'æ³•è¯­': (5, 6, 3),
        'è¥¿ç­ç‰™è¯­': (5, 6, 3),
        
        # ========== è‰ºæœ¯ç±»ï¼ˆæé«˜åˆ›é€ ã€ä¸­äººé™…ã€ä½å£å’ï¼‰==========
        'è‰ºæœ¯è®¾è®¡å­¦': (10, 6, 4),
        'è§†è§‰ä¼ è¾¾è®¾è®¡': (10, 6, 4),
        'ç¯å¢ƒè®¾è®¡': (9, 7, 5),
        'äº§å“è®¾è®¡': (9, 6, 4),
        'éŸ³ä¹è¡¨æ¼”': (10, 8, 6),
        'ç»˜ç”»': (10, 5, 5),
        'ç¾æœ¯å­¦': (10, 6, 5),
        'åŠ¨ç”»': (9, 5, 4),
        
        # ========== å†œå­¦ç±»ï¼ˆä¸­åˆ›é€ ã€ä¸­äººé™…ã€ä¸­é«˜å£å’ï¼‰==========
        'å†œå­¦': (6, 6, 6),
        'å›­è‰º': (6, 6, 5),
        'åŠ¨ç‰©åŒ»å­¦': (7, 8, 9),
        'æ—å­¦': (6, 5, 6),
        'æ°´äº§å…»æ®–å­¦': (6, 6, 6),
        
        # ========== æ•™è‚²ç±»ï¼ˆé«˜åˆ›é€ ã€æé«˜äººé™…ã€ä¸­å£å’ï¼‰==========
        'æ•™è‚²å­¦': (7, 9, 6),
        'å­¦å‰æ•™è‚²': (6, 10, 5),
        'å°å­¦æ•™è‚²': (7, 9, 6),
        'ä½“è‚²æ•™è‚²': (6, 9, 5),
        'æ•™è‚²æŠ€æœ¯å­¦': (6, 6, 5),
        
        # ========== å…¶ä»– ==========
        'å…¬å…±äº‹ä¸šç®¡ç†': (5, 7, 3),
        'è¡Œæ”¿ç®¡ç†': (6, 7, 4),
        'æ—…æ¸¸ç®¡ç†': (6, 8, 3),
        'å›¾ä¹¦é¦†å­¦': (5, 5, 4),
        'æ¡£æ¡ˆå­¦': (5, 5, 4),
    }
    
    # è®¡ç®—æœ¬ç§‘æŠ—AIæŒ‡æ•°
    def calc_base_index(major):
        if major not in professional_scores:
            return 0.50  # é»˜è®¤ä¸­ç­‰é£é™©
        
        creativity, interaction, barrier = professional_scores[major]
        
        # åŠ æƒè®¡ç®—ï¼ˆ0-10åˆ†è½¬ä¸º0-1åˆ†ï¼‰
        base_score = (creativity * 0.4 + interaction * 0.3 + barrier * 0.3) / 10
        
        return round(base_score, 2)
    
    df['æœ¬ç§‘æŠ—AIæŒ‡æ•°'] = df['ä¸“ä¸š'].apply(calc_base_index)
    
    # è®¡ç®—ç¡•å£«æŠ—AIæŒ‡æ•°ï¼ˆåŠ å…¥å­¦å†ä¿æŠ¤ç³»æ•°ï¼‰
    def calc_master_index(row):
        base = row['æœ¬ç§‘æŠ—AIæŒ‡æ•°']
        category = row['å­¦ç§‘é—¨ç±»']
        
        # å­¦å†ä¿æŠ¤ç³»æ•°ï¼ˆç¡•å£«é™ä½AIæ›¿ä»£é£é™©ï¼‰
        protection_bonus = {
            'åŒ»å­¦': 0.15,  # åŒ»å­¦ç¡•å£«å¤§å¹…é™ä½é£é™©
            'ç†å­¦': 0.12,  # ç†å­¦ç¡•å£«ç§‘ç ”èƒ½åŠ›æå‡
            'å·¥ç§‘': 0.10,  # å·¥ç§‘ç¡•å£«ç³»ç»Ÿèƒ½åŠ›æå‡
            'æ³•å­¦': 0.10,  # æ³•å­¦ç¡•å£«ä¸“ä¸šæ·±åº¦
            'ç»ç®¡': 0.08,  # ç»ç®¡ç¡•å£«ç®¡ç†èƒ½åŠ›
            'æ•™è‚²': 0.08,
            'å†œå­¦': 0.08,
            'å¤–è¯­': 0.05,  # å¤–è¯­ç¡•å£«è¾¹é™…æ”¶ç›Šå°
            'è‰ºæœ¯': 0.05,  # è‰ºæœ¯ç¡•å£«ä¸»è¦é ä½œå“
            'å…¶ä»–': 0.05
        }
        
        bonus = protection_bonus.get(category, 0.08)
        master_index = min(base + bonus, 1.0)
        
        return round(master_index, 2)
    
    df['ç¡•å£«æŠ—AIæŒ‡æ•°'] = df.apply(calc_master_index, axis=1)
    df['å­¦å†AIé˜²æŠ¤æå‡'] = ((df['ç¡•å£«æŠ—AIæŒ‡æ•°'] - df['æœ¬ç§‘æŠ—AIæŒ‡æ•°']) * 100).round(1)
    
    # AIæ›¿ä»£é£é™©è¯„çº§
    def risk_level(index):
        if index >= 0.75:
            return 'ä½é£é™©'
        elif index >= 0.55:
            return 'ä¸­é£é™©'
        else:
            return 'é«˜é£é™©'
    
    df['æœ¬ç§‘AIé£é™©ç­‰çº§'] = df['æœ¬ç§‘æŠ—AIæŒ‡æ•°'].apply(risk_level)
    df['ç¡•å£«AIé£é™©ç­‰çº§'] = df['ç¡•å£«æŠ—AIæŒ‡æ•°'].apply(risk_level)
    
    return df


def analyze_key_insights(df):
    """æ ¸å¿ƒæ´å¯Ÿåˆ†æ"""
    
    print("\n" + "="*70)
    print("ğŸ“Š æ ¸å¿ƒæ•°æ®æ´å¯Ÿ")
    print("="*70)
    
    # æ´å¯Ÿ1ï¼šæœ€å±é™©çš„ä¸“ä¸š
    print("\nâš ï¸ ã€æ´å¯Ÿ1ã€‘AIæ›¿ä»£é£é™©æœ€é«˜çš„10ä¸ªæœ¬ç§‘ä¸“ä¸šï¼š")
    high_risk = df.nsmallest(10, 'æœ¬ç§‘æŠ—AIæŒ‡æ•°')[
        ['ä¸“ä¸š', 'å­¦ç§‘é—¨ç±»', 'æœ¬ç§‘æŠ—AIæŒ‡æ•°', 'æœ¬ç§‘AIé£é™©ç­‰çº§', 'æœ¬ç§‘æœˆè–ª']
    ]
    print(high_risk.to_string(index=False))
    
    # æ´å¯Ÿ2ï¼šæœ€å®‰å…¨çš„ä¸“ä¸š
    print("\nâœ… ã€æ´å¯Ÿ2ã€‘AIæ›¿ä»£é£é™©æœ€ä½çš„10ä¸ªä¸“ä¸šï¼š")
    low_risk = df.nlargest(10, 'æœ¬ç§‘æŠ—AIæŒ‡æ•°')[
        ['ä¸“ä¸š', 'å­¦ç§‘é—¨ç±»', 'æœ¬ç§‘æŠ—AIæŒ‡æ•°', 'æœ¬ç§‘AIé£é™©ç­‰çº§', 'æœ¬ç§‘æœˆè–ª']
    ]
    print(low_risk.to_string(index=False))
    
    # æ´å¯Ÿ3ï¼šå­¦å†æœ€å€¼å¾—è¯»çš„ä¸“ä¸š
    print("\nğŸ“ ã€æ´å¯Ÿ3ã€‘å­¦å†ä¿æŠ¤æ•ˆåº”æœ€å¼ºçš„10ä¸ªä¸“ä¸šï¼š")
    df['ç»¼åˆå­¦å†ä»·å€¼'] = (df['å­¦å†è–ªèµ„æº¢ä»·ç‡%'] + df['å­¦å†AIé˜²æŠ¤æå‡']) / 2
    best_master = df.nlargest(10, 'ç»¼åˆå­¦å†ä»·å€¼')[
        ['ä¸“ä¸š', 'å­¦ç§‘é—¨ç±»', 'å­¦å†è–ªèµ„æº¢ä»·ç‡%', 'å­¦å†AIé˜²æŠ¤æå‡', 'ç»¼åˆå­¦å†ä»·å€¼']
    ]
    print(best_master.to_string(index=False))
    
    # æ´å¯Ÿ4ï¼šå­¦å†æ€§ä»·æ¯”æœ€ä½çš„ä¸“ä¸š
    print("\nğŸ’¸ ã€æ´å¯Ÿ4ã€‘è€ƒç ”æ€§ä»·æ¯”æœ€ä½çš„10ä¸ªä¸“ä¸šï¼š")
    worst_master = df.nsmallest(10, 'ç»¼åˆå­¦å†ä»·å€¼')[
        ['ä¸“ä¸š', 'å­¦ç§‘é—¨ç±»', 'å­¦å†è–ªèµ„æº¢ä»·ç‡%', 'å­¦å†AIé˜²æŠ¤æå‡', 'ç»¼åˆå­¦å†ä»·å€¼']
    ]
    print(worst_master.to_string(index=False))
    
    # æ´å¯Ÿ5ï¼šçº¢ç»¿ç‰ŒçœŸç›¸
    print("\nğŸ” ã€æ´å¯Ÿ5ã€‘çº¢ç»¿ç‰Œä¸“ä¸šçš„AIé£é™©å¯¹æ¯”ï¼š")
    badge_analysis = df[df['çº¢ç»¿ç‰Œ'] != 'æ™®é€š'].groupby('çº¢ç»¿ç‰Œ').agg({
        'æœ¬ç§‘æŠ—AIæŒ‡æ•°': 'mean',
        'æœ¬ç§‘æœˆè–ª': 'mean',
        'å­¦å†è–ªèµ„æº¢ä»·ç‡%': 'mean'
    }).round(2)
    print(badge_analysis)
    
    # æ´å¯Ÿ6ï¼šå­¦ç§‘é—¨ç±»å¯¹æ¯”
    print("\nğŸ“š ã€æ´å¯Ÿ6ã€‘å„å­¦ç§‘é—¨ç±»çš„å¹³å‡æŒ‡æ ‡ï¼š")
    category_stats = df.groupby('å­¦ç§‘é—¨ç±»').agg({
        'æœ¬ç§‘æŠ—AIæŒ‡æ•°': 'mean',
        'æœ¬ç§‘æœˆè–ª': 'mean',
        'æœ¬ç§‘å°±ä¸šç‡': 'mean',
        'å­¦å†è–ªèµ„æº¢ä»·ç‡%': 'mean'
    }).round(2).sort_values('æœ¬ç§‘æŠ—AIæŒ‡æ•°', ascending=False)
    print(category_stats)


def main():
    """ä¸»å‡½æ•°"""
    print("="*70)
    print("ğŸ§® ç¬¬äºŒæ­¥ï¼šæŠ—AIæŒ‡æ•°è®¡ç®—ä¸æ ¸å¿ƒåˆ†æ")
    print("="*70)
    
    # è®¡ç®—æŠ—AIæŒ‡æ•°
    print("\nâ³ æ­£åœ¨è®¡ç®—æŠ—AIæŒ‡æ•°...")
    df = calculate_anti_ai_index()
    
    print(f"âœ… è®¡ç®—å®Œæˆï¼88ä¸ªä¸“ä¸šçš„æŠ—AIæŒ‡æ•°å·²ç”Ÿæˆ")
    
    # æ ¸å¿ƒåˆ†æ
    analyze_key_insights(df)
    
    # ä¿å­˜å¢å¼ºæ•°æ®
    output_file = 'data/reference/major_data_with_ai_index.csv'
    df.to_csv(output_file, index=False, encoding='utf-8-sig')
    
    print(f"\nğŸ’¾ å¢å¼ºæ•°æ®å·²ä¿å­˜åˆ°: {output_file}")
    print("\n" + "="*70)
    print("âœ… ç¬¬äºŒæ­¥å®Œæˆï¼")
    print("ğŸ‘‰ ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ step3_visualization.pyï¼ˆç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼‰")
    print("="*70)


if __name__ == "__main__":
    main()
